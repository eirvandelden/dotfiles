#!/usr/bin/env rv run ruby
# frozen_string_literal: true

# Add lib directory to load path
$LOAD_PATH.unshift(File.expand_path('lib', __dir__))

require 'common'
require 'detect'
require 'config'
require 'symlinker'
require 'puma_dev'

module WorktreeTools
  class Remove
    include Helpers

    def initialize(path = '.')
      @path = File.expand_path(path)
    end

    def run!
      log "Worktree cleanup for: #{@path}"
      log ""

      # Detect project type
      detector = ProjectDetector.new(@path).detect!

      # Load configuration
      config = WorktreeConfig.new(@path, detector).load!

      # Remove puma-dev
      if config.puma_dev_enabled?
        puma_dev = PumaDev.new(config, @path)
        puma_dev.remove!
        log ""
      end

      # Remove symlinks via Stow
      if config.stow_enabled?
        symlinker = Symlinker.new(config)
        symlinker.remove!
        log ""
      end

      log "Worktree cleanup complete!"
      log ""
      log "You can now run: git worktree remove #{@path}"

    rescue Error => e
      error e.message

      case e
      when ConfigError
        exit EXIT_CONFIG_ERROR
      when StowError
        exit EXIT_STOW_ERROR
      when DetectionError
        exit EXIT_DETECTION_ERROR
      else
        exit EXIT_ERROR
      end
    rescue StandardError => e
      error "Unexpected error: #{e.message}"
      error e.backtrace.join("\n") if ENV['DEBUG']
      exit EXIT_ERROR
    end
  end
end

# Run if called directly
if __FILE__ == $0
  if ARGV.empty?
    $stderr.puts "Usage: worktree-remove <worktree-path>"
    $stderr.puts ""
    $stderr.puts "Remove worktree setup (puma-dev symlink, stow packages)"
    $stderr.puts "Run this before 'git worktree remove'"
    exit 1
  end

  path = ARGV[0]
  WorktreeTools::Remove.new(path).run!
end
