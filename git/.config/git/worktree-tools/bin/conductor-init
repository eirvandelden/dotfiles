#!/bin/bash
# conductor-init: Initialize a project with Conductor templates
# Usage: conductor-init <project-name> [port]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATES_DIR="$(dirname "$SCRIPT_DIR")/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
  echo -e "${GREEN}==>${NC} $*"
}

warn() {
  echo -e "${YELLOW}warning:${NC} $*" >&2
}

error() {
  echo -e "${RED}error:${NC} $*" >&2
}

die() {
  error "$*"
  exit 1
}

# Parse arguments
if [ $# -lt 1 ]; then
  cat <<EOF
Usage: conductor-init <project-name> [port]

Initialize a project with Conductor integration templates.

Arguments:
  project-name    Name of the project (e.g., 'myapp')
  port           Base port number (default: 3000)

Example:
  conductor-init myapp 3000

This will create:
  - conductor.json       # Conductor configuration
  - bin/conductor-setup  # Setup script for Conductor
  - script/server        # Universal server launcher
EOF
  exit 1
fi

PROJECT_NAME="$1"
PORT="${2:-3000}"

# Validate project name
if [[ ! "$PROJECT_NAME" =~ ^[a-z0-9-]+$ ]]; then
  die "Invalid project name: $PROJECT_NAME (must contain only lowercase letters, numbers, and hyphens)"
fi

log "Initializing Conductor integration for: $PROJECT_NAME"
log "Port: $PORT"
echo ""

# Check if we're in a git repository
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  die "Not in a git repository"
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

log "Repository root: $REPO_ROOT"
echo ""

# Create conductor.json
if [ -f "conductor.json" ]; then
  warn "conductor.json already exists, skipping"
else
  log "Creating conductor.json..."
  sed "s/{{PROJECT_NAME}}/$PROJECT_NAME/g; s/{{PORT}}/$PORT/g" \
    "$TEMPLATES_DIR/conductor.json.template" > conductor.json
  log "  Created: conductor.json"
fi

# Create bin directory if needed
if [ ! -d "bin" ]; then
  mkdir -p bin
  log "Created: bin/"
fi

# Create bin/conductor-setup
if [ -f "bin/conductor-setup" ]; then
  warn "bin/conductor-setup already exists, skipping"
else
  log "Creating bin/conductor-setup..."
  cp "$TEMPLATES_DIR/bin-conductor-setup.template" bin/conductor-setup
  chmod +x bin/conductor-setup
  log "  Created: bin/conductor-setup"
fi

# Create script directory if needed
if [ ! -d "script" ]; then
  mkdir -p script
  log "Created: script/"
fi

# Create script/server
if [ -f "script/server" ]; then
  warn "script/server already exists, skipping"
else
  log "Creating script/server..."
  cp "$TEMPLATES_DIR/script-server.template" script/server
  chmod +x script/server
  log "  Created: script/server"
fi

echo ""
log "Conductor initialization complete!"
echo ""

cat <<EOF
${GREEN}Next steps:${NC}

1. Review and customize the generated files:
   - conductor.json       # Conductor configuration
   - bin/conductor-setup  # Runs on workspace creation
   - script/server        # Server startup script

2. (Optional) Create a .worktree.yml for worktree automation:
   ${YELLOW}cat > .worktree.yml <<'YAML'
   project:
     name: $PROJECT_NAME

   stow:
     enabled: true
     packages:
       - ruby

   puma_dev:
     enabled: true
   YAML${NC}

3. (Optional) Create .worktree-local/ directory for shared files:
   ${YELLOW}mkdir -p .worktree-local
   # Add files to share across worktrees (e.g., .env, master.key)${NC}

4. Test the setup:
   ${YELLOW}./bin/conductor-setup${NC}

5. Test the server:
   ${YELLOW}./script/server${NC}

For more information, see:
  ${HOME}/.config/git/worktree-tools/README.md
EOF
