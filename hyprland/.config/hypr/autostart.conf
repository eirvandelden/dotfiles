# SteamOS / Steam Deck autostart.conf (Omarchy-aligned split config)
#
# Keep this file focused on "session services" that should start once when Hyprland starts.
# This is tuned for running Hyprland nested under gamescope from Steam Gaming Mode.
#
# Goals:
# - Ensure portals work (file pickers, screen sharing APIs, etc.)
# - Ensure notifications work (mako)
# - Ensure a polkit agent is available for auth prompts
#
# Notes:
# - Many commands are best-effort: if a binary isn't installed, it will be skipped.
# - We use `sh -lc` so PATH/env from your shell (and wrapper script) are respected.

#############################
# Propagate environment
#############################

# Make sure DBus/systemd user session sees relevant variables.
exec-once = sh -lc 'command -v dbus-update-activation-environment >/dev/null 2>&1 && dbus-update-activation-environment --systemd --all || true'
exec-once = sh -lc 'command -v systemctl >/dev/null 2>&1 && systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP XDG_SESSION_TYPE PATH || true'

#############################
# Portals
#############################

# Start the base portal service if available. Backends (hyprland/wlr/gtk) are typically
# activated automatically depending on what is installed and on XDG_CURRENT_DESKTOP.
exec-once = sh -lc '\
  if command -v xdg-desktop-portal >/dev/null 2>&1; then \
    pgrep -x xdg-desktop-portal >/dev/null 2>&1 || xdg-desktop-portal; \
  fi \
  || true'

# Some SteamOS setups benefit from explicitly starting the Hyprland portal backend.
# This is best-effort and will no-op if not installed.
exec-once = sh -lc '\
  if command -v xdg-desktop-portal-hyprland >/dev/null 2>&1; then \
    pgrep -x xdg-desktop-portal-hyprland >/dev/null 2>&1 || xdg-desktop-portal-hyprland; \
  fi \
  || true'

#############################
# Notifications
#############################

# Start mako if installed (lightweight Wayland notification daemon).
exec-once = sh -lc 'command -v mako >/dev/null 2>&1 && (pgrep -x mako >/dev/null 2>&1 || mako) || true'

#############################
# Polkit agent
#############################

# Ensure a polkit authentication agent is running for GUI prompts (mounts, network, etc.)
# We try common agents in a stable order; only one will be launched.
exec-once = sh -lc '\
  if command -v /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 >/dev/null 2>&1; then \
    pgrep -f polkit-gnome-authentication-agent-1 >/dev/null 2>&1 || /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1; \
  elif command -v polkit-gnome-authentication-agent-1 >/dev/null 2>&1; then \
    pgrep -f polkit-gnome-authentication-agent-1 >/dev/null 2>&1 || polkit-gnome-authentication-agent-1; \
  elif command -v lxqt-policykit-agent >/dev/null 2>&1; then \
    pgrep -x lxqt-policykit-agent >/dev/null 2>&1 || lxqt-policykit-agent; \
  elif command -v polkit-kde-authentication-agent-1 >/dev/null 2>&1; then \
    pgrep -x polkit-kde-authentication-agent-1 >/dev/null 2>&1 || polkit-kde-authentication-agent-1; \
  else \
    true; \
  fi'
